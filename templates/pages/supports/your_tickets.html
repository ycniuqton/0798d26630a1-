{% extends 'layouts/base.html' %}
{% load static %}

{% block breadcrumbs %}{% endblock breadcrumbs %}

{% block extrastyle %}
<style>
    .iframe-container {display: flex; width: 100%; height: 100%; flex-direction: column; overflow: hidden;}
    .parent-fit { flex-grow: 1; border: none; margin: 0; padding: 0; height: 100vh; }
    .search-bar { display: flex; align-items: center; margin-bottom: 20px; }
    .search-bar input, .search-bar select, .search-bar button { margin-right: 10px; }
    .table thead th { background-color: #f8f9fa; cursor: pointer; }
    .no-records { text-align: center; padding: 50px 0; }
    .no-records img { max-width: 150px; margin-bottom: 20px; }
    .no-records h4 { margin-top: 20px; }
    .ticket-form { margin-bottom: 20px; }
    .ticket-form textarea { resize: none; }
</style>
{% endblock extrastyle %}

{% block content %}
<div class="container mt-4">
    <div class="search-bar mb-4">
        <input type="text" class="form-control" id="search-input" placeholder="Please enter" aria-label="Search">
        <select class="form-control" id="subject-filter-select">
            <option value="">Subject</option>
            <!-- Add more options here if needed -->
        </select>
        <button class="btn btn-outline-secondary" id="search-button"><i class="fas fa-sync-alt"></i></button>
    </div>
    <table class="table table-hover">
        <thead>
            <tr>
                <th scope="col" data-sort="ticket_id">Ticket ID</th>
                <th scope="col" data-sort="subject">Subject</th>
                <th scope="col" data-sort="ticket_type">Ticket Type</th>
                <th scope="col" data-sort="submission_time">Submission Time</th>
                <th scope="col" data-sort="status">Status</th>
                <th scope="col">Operation</th>
            </tr>
        </thead>
        <tbody id="ticket-list">
            <!-- Tickets will be loaded here via AJAX -->
        </tbody>
    </table>
    <nav>
        <ul class="pagination" id="pagination">
            <!-- Pagination will be loaded here via AJAX -->
        </ul>
    </nav>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let currentPage = 1;
        let currentSort = '-submission_time';
        let currentFilter = '';

        window.loadTickets = function(page = 1, sort = '-submission_time', filter = '') {
            const searchQuery = document.getElementById('search-input').value;
            fetch(`/api/your_tickets/?page=${page}&page_size=10&sort_by=${sort}&${filter}&search=${searchQuery}`)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('ticket-list');
                    tbody.innerHTML = '';
                    data.tickets.forEach(ticket => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${ticket.ticket_id}</td>
                            <td>${ticket.subject}</td>
                            <td>${ticket.ticket_type}</td>
                            <td>${ticket.submission_time}</td>
                            <td>${ticket.status}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary">${ticket.operation}</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });

                    const pagination = document.getElementById('pagination');
                    pagination.innerHTML = '';
                    for (let i = 1; i <= data.total_pages; i++) {
                        const pageItem = document.createElement('li');
                        pageItem.className = 'page-item' + (i === data.current_page ? ' active' : '');
                        pageItem.innerHTML = `<a class="page-link" onclick="loadTickets(${i}, '${sort}', '${filter}')">${i}</a>`;
                        pagination.appendChild(pageItem);
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        document.getElementById('search-button').addEventListener('click', () => {
            loadTickets(currentPage, currentSort, currentFilter);
        });

        document.getElementById('subject-filter-select').addEventListener('change', (event) => {
            currentFilter = event.target.value ? `subject=${event.target.value}` : '';
            loadTickets(currentPage, currentSort, currentFilter);
        });

        document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', () => {
                const sortField = th.getAttribute('data-sort');
                currentSort = currentSort === sortField ? `-${sortField}` : sortField;
                loadTickets(currentPage, currentSort, currentFilter);
            });
        });

        loadTickets();
    });
</script>
{% endblock content %}
